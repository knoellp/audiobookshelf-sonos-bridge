{{define "transport"}}
<div class="transport-controls">
    <!-- Current Chapter Display -->
    {{if and .Item .Item.Media.Chapters}}
    <div class="current-chapter" id="current-chapter">
        <span class="chapter-number-display" id="chapter-number">--</span>
        <span class="chapter-title" id="chapter-title"></span>
    </div>
    {{end}}

    <!-- Progress Bar with Chapters -->
    <div class="progress-container">
        <span class="time" id="position">{{if .Playback}}{{.Playback.PositionSec | formatDuration}}{{else}}0:00{{end}}</span>
        <div class="progress-wrapper">
            <input type="range"
                   id="progress-slider"
                   class="progress-slider"
                   min="0"
                   max="{{if .Playback}}{{.Playback.DurationSec}}{{else}}0{{end}}"
                   value="{{if .Playback}}{{.Playback.PositionSec}}{{else}}0{{end}}"
                   oninput="onProgressChange(this.value)"
                   onchange="onProgressSeek(this.value)">
            <!-- Chapter markers -->
            <div class="chapter-markers" id="chapter-markers"></div>
        </div>
        <span class="time" id="duration">{{if .Playback}}{{.Playback.DurationSec | formatDuration}}{{else}}0:00{{end}}</span>
        <input type="hidden" id="progress-input" value="{{if .Playback}}{{.Playback.PositionSec}}{{else}}0{{end}}">
        <input type="hidden" id="duration-input" value="{{if .Playback}}{{.Playback.DurationSec}}{{else}}0{{end}}">
    </div>

    <!-- Chapter List (collapsible) -->
    {{if and .Item .Item.Media.Chapters}}
    <div class="chapter-list-container">
        <button type="button" class="chapter-toggle" id="chapter-toggle" onclick="toggleChapterList()">
            <span>Kapitel anzeigen</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="chapter-arrow">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>
        <div class="chapter-list" id="chapter-list" style="display: none;">
            {{range $i, $ch := .Item.Media.Chapters}}
            <button type="button" class="chapter-item" data-start="{{$ch.Start}}" onclick="seekToChapter({{$ch.Start}})">
                <span class="chapter-number">{{$i | plus1}}</span>
                <span class="chapter-name">{{$ch.Title}}</span>
            </button>
            {{end}}
        </div>
    </div>
    {{end}}

    <!-- Store chapters as JSON for JavaScript -->
    <script id="chapters-data" type="application/json">
    {{if and .Item .Item.Media.Chapters}}{{.Item.Media.Chapters | json}}{{else}}[]{{end}}
    </script>

    <div class="transport-buttons">
        {{if and .Item .Item.Media.Chapters}}
        <button type="button" class="transport-btn chapter-skip-btn" id="prev-chapter-btn" onclick="skipToPrevChapter()" title="Vorheriges Kapitel">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <rect x="3" y="5" width="3" height="14"></rect>
                <polygon points="21 5 21 19 9 12 21 5"></polygon>
            </svg>
        </button>
        {{end}}

        <button type="button" class="transport-btn" onclick="skip(-12)" title="12 Sekunden zurück">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
                <text x="12" y="15" font-size="6" text-anchor="middle" fill="currentColor" stroke="none">12</text>
            </svg>
        </button>

        <button type="button" class="transport-btn play-btn" id="play-btn" onclick="resume()" title="Play" {{if and .Playback .Playback.IsPlaying}}style="display:none"{{end}}>
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
        </button>

        <button type="button" class="transport-btn pause-btn" id="pause-btn" onclick="pause()" title="Pause" {{if or (not .Playback) (not .Playback.IsPlaying)}}style="display:none"{{end}}>
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
        </button>

        <button type="button" class="transport-btn" onclick="skip(12)" title="12 Sekunden vor">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
                <text x="12" y="15" font-size="6" text-anchor="middle" fill="currentColor" stroke="none">12</text>
            </svg>
        </button>

        {{if and .Item .Item.Media.Chapters}}
        <button type="button" class="transport-btn chapter-skip-btn" id="next-chapter-btn" onclick="skipToNextChapter()" title="Nächstes Kapitel">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <polygon points="3 5 3 19 15 12 3 5"></polygon>
                <rect x="18" y="5" width="3" height="14"></rect>
            </svg>
        </button>
        {{end}}
    </div>

    <div class="volume-controls">
        <button type="button" class="volume-btn" id="mute-btn" onclick="toggleMute()" title="Mute/Unmute">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="volume-icon">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="mute-icon" style="display:none">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <line x1="23" y1="9" x2="17" y2="15"></line>
                <line x1="17" y1="9" x2="23" y2="15"></line>
            </svg>
        </button>
        <span class="group-label" id="group-label" style="display:none">Gruppe</span>
        <button type="button" class="volume-adjust-btn" onclick="adjustVolume(-1)" title="Leiser">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
        <input type="range"
               id="volume-slider"
               class="volume-slider"
               min="0"
               max="100"
               value="50"
               oninput="onVolumeChange(this.value)"
               onchange="setVolume(this.value)">
        <button type="button" class="volume-adjust-btn" onclick="adjustVolume(1)" title="Lauter">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
        <span class="volume-value" id="volume-value">50%</span>
    </div>

    <!-- Individual Member Volumes (collapsible, shown only for groups) -->
    <div class="member-volumes-container" id="member-volumes-container" style="display:none">
        <button type="button" class="member-volumes-toggle" id="member-volumes-toggle" onclick="toggleMemberVolumes()">
            <span id="member-toggle-text">Einzelne Lautsprecher</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="member-arrow">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>
        <div class="member-volumes-list" id="member-volumes-list" style="display:none">
            <!-- Members will be populated dynamically -->
        </div>
    </div>

    <div class="transport-secondary">
        <button type="button" class="transport-btn-secondary" onclick="stop()" title="Stop">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <rect x="4" y="4" width="16" height="16" rx="2"></rect>
            </svg>
            Stop
        </button>
        <button type="button" class="transport-btn-secondary group-btn" id="group-manage-btn" onclick="openGroupEditor()" title="Gruppe verwalten">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Gruppe
        </button>
    </div>
</div>

<!-- Group Editor Modal -->
<div class="group-modal-overlay" id="group-modal" style="display:none" onclick="closeGroupEditorOnOverlay(event)">
    <div class="group-modal">
        <div class="group-modal-header">
            <h3>Gruppe verwalten</h3>
            <button type="button" class="group-modal-close" onclick="closeGroupEditor()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="group-modal-body">
            <div class="group-section">
                <h4>Aktuelle Gruppe</h4>
                <div class="group-current-list" id="group-current-list">
                    <div class="group-loading">Lade...</div>
                </div>
            </div>
            <div class="group-section">
                <h4>Verfügbare Lautsprecher</h4>
                <div class="group-available-list" id="group-available-list">
                    <div class="group-loading">Lade...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Progress/seek control
let seekAdjusting = false;
let seekAdjustTimeout;
let chapters = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize chapters from JSON data
    const chaptersData = document.getElementById('chapters-data');
    if (chaptersData) {
        try {
            chapters = JSON.parse(chaptersData.textContent.trim());
            renderChapterMarkers();
            // Initialize current chapter display with current position
            const initialPosition = parseInt(document.getElementById('progress-input').value) || 0;
            updateCurrentChapterDisplay(initialPosition);
        } catch (e) {
            console.error('Failed to parse chapters:', e);
        }
    }

    // Check group info for volume control
    checkGroupInfo();

    // Listen for player selection changes in header
    document.addEventListener('sonosDeviceSelected', function(e) {
        const newUuid = e.detail ? e.detail.uuid : null;

        // When a different player is selected, update all related UI
        setTimeout(async () => {
            checkGroupInfo();
            // Update member volumes if expanded
            if (memberVolumesExpanded) {
                fetchMemberVolumes();
            }
            // Update group editor if open
            if (groupEditorOpen) {
                fetchAllPlayers();
            }

            // If playback is active for THIS item, transfer it to the new player
            const container = document.getElementById('player-container');
            const currentItemId = container ? container.dataset.itemId : null;

            if (playbackActive && playbackItemId === currentItemId && newUuid) {
                // Transfer playback to new player by calling resume with new UUID
                // This will stop the old player and start on the new one at the same position
                const success = await transportAction('resume', { sonos_uuid: newUuid });
                if (success) {
                    console.log('Playback transferred to new player:', newUuid);
                }
            }
        }, 100);
    });
});

function renderChapterMarkers() {
    const markers = document.getElementById('chapter-markers');
    const duration = parseInt(document.getElementById('duration-input').value);
    if (!markers || !duration || chapters.length === 0) return;

    markers.innerHTML = '';
    chapters.forEach((ch, i) => {
        if (i === 0) return; // Skip first chapter (start)
        const percent = (ch.start / duration) * 100;
        const marker = document.createElement('div');
        marker.className = 'chapter-marker';
        marker.style.left = percent + '%';
        marker.title = ch.title;
        marker.onclick = (e) => {
            e.stopPropagation();
            seekToChapter(ch.start);
        };
        markers.appendChild(marker);
    });
}

function getCurrentChapterWithIndex(positionSec) {
    if (!chapters || chapters.length === 0) return { chapter: null, index: -1 };
    for (let i = chapters.length - 1; i >= 0; i--) {
        if (positionSec >= chapters[i].start) {
            return { chapter: chapters[i], index: i };
        }
    }
    return { chapter: chapters[0], index: 0 };
}

function updateCurrentChapterDisplay(positionSec) {
    const numberEl = document.getElementById('chapter-number');
    const titleEl = document.getElementById('chapter-title');

    const { chapter, index } = getCurrentChapterWithIndex(positionSec);
    if (chapter) {
        // Show chapter number (1-based)
        if (numberEl) {
            numberEl.textContent = (index + 1) + ' / ' + chapters.length;
        }
        // Show title if it's not just a generic "Chapter X" / "Kapitel X" pattern
        if (titleEl) {
            const title = chapter.title || '';
            // Check if title is just a number pattern like "Kapitel 5" or "Chapter 5"
            const isGenericTitle = /^(kapitel|chapter|teil|part|abschnitt|section)\s*\d+$/i.test(title.trim());
            if (title && !isGenericTitle) {
                titleEl.textContent = title;
                titleEl.style.display = 'inline';
            } else {
                titleEl.textContent = '';
                titleEl.style.display = 'none';
            }
        }

        // Highlight current chapter in the chapter list
        highlightCurrentChapter(index);
    }
}

function highlightCurrentChapter(currentIndex) {
    const chapterList = document.getElementById('chapter-list');
    if (!chapterList) return;

    const items = chapterList.querySelectorAll('.chapter-item');
    items.forEach((item, i) => {
        if (i === currentIndex) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

function onProgressChange(value) {
    // User is dragging - set flag to prevent status updates
    seekAdjusting = true;
    clearTimeout(seekAdjustTimeout);
    // Update time display immediately
    document.getElementById('position').textContent = formatSecondsDisplay(parseInt(value));
    updateCurrentChapterDisplay(parseInt(value));
}

function onProgressSeek(value) {
    // User released slider - seek to position
    seek(parseInt(value));
    // Reset flag after delay
    clearTimeout(seekAdjustTimeout);
    seekAdjustTimeout = setTimeout(() => {
        seekAdjusting = false;
    }, 1500);
}

function seekToChapter(startSec) {
    seek(Math.round(startSec));
}

function getCurrentChapterIndex(positionSec) {
    if (!chapters || chapters.length === 0) return -1;
    for (let i = chapters.length - 1; i >= 0; i--) {
        if (positionSec >= chapters[i].start) {
            return i;
        }
    }
    return 0;
}

function skipToPrevChapter() {
    if (!chapters || chapters.length === 0) return;

    const currentPosition = parseInt(document.getElementById('progress-slider').value) || 0;
    const currentIndex = getCurrentChapterIndex(currentPosition);

    // If we're more than 3 seconds into the current chapter, go to start of current chapter
    // Otherwise go to previous chapter
    const currentChapterStart = chapters[currentIndex]?.start || 0;
    const secondsIntoChapter = currentPosition - currentChapterStart;

    if (secondsIntoChapter > 3 && currentIndex >= 0) {
        // Go to start of current chapter
        seekToChapter(currentChapterStart);
    } else if (currentIndex > 0) {
        // Go to previous chapter
        seekToChapter(chapters[currentIndex - 1].start);
    } else {
        // Already at first chapter, go to start
        seekToChapter(0);
    }
}

function skipToNextChapter() {
    if (!chapters || chapters.length === 0) return;

    const currentPosition = parseInt(document.getElementById('progress-slider').value) || 0;
    const currentIndex = getCurrentChapterIndex(currentPosition);

    if (currentIndex < chapters.length - 1) {
        // Go to next chapter
        seekToChapter(chapters[currentIndex + 1].start);
    }
    // If at last chapter, do nothing (or could go to end)
}

function toggleChapterList() {
    const list = document.getElementById('chapter-list');
    const arrow = document.getElementById('chapter-arrow');
    const toggle = document.getElementById('chapter-toggle');
    if (list.style.display === 'none') {
        list.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
        toggle.querySelector('span').textContent = 'Kapitel ausblenden';
    } else {
        list.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
        toggle.querySelector('span').textContent = 'Kapitel anzeigen';
    }
}

function formatSecondsDisplay(sec) {
    const hours = Math.floor(sec / 3600);
    const minutes = Math.floor((sec % 3600) / 60);
    const seconds = Math.floor(sec % 60);
    if (hours > 0) {
        return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
    return `${minutes}:${String(seconds).padStart(2, '0')}`;
}

// Update progress slider from status (called from player.html updateStatus)
function updateProgressUI(positionSec, durationSec) {
    if (seekAdjusting) return; // Don't update while user is dragging

    const slider = document.getElementById('progress-slider');
    if (slider) {
        slider.max = durationSec;
        slider.value = positionSec;
    }
    document.getElementById('progress-input').value = positionSec;
    document.getElementById('duration-input').value = durationSec;
    updateCurrentChapterDisplay(positionSec);
}

// Volume control functions
let volumeDebounceTimer;
let volumeAdjusting = false;  // Flag to prevent status updates from overwriting slider
let volumeAdjustTimeout;
let isGroupMode = false;  // Flag to track if we're controlling group volume
let groupSize = 1;

async function checkGroupInfo() {
    try {
        // Get selected device UUID from header button or localStorage
        const sonosBtn = document.getElementById('sonos-picker-toggle');
        let sonosUuid = sonosBtn ? sonosBtn.dataset.sonosUuid : null;
        if (!sonosUuid) {
            sonosUuid = localStorage.getItem('selectedSonosUUID');
        }

        // Build URL with optional uuid parameter
        let url = '/sonos/group-info';
        if (sonosUuid) {
            url += '?uuid=' + encodeURIComponent(sonosUuid);
        }

        const response = await fetch(url);
        if (response.ok) {
            const data = await response.json();
            isGroupMode = data.is_group;
            groupSize = data.group_size || 1;
            updateGroupVolumeUI();

            if (isGroupMode) {
                // Fetch initial group volume
                fetchGroupVolume();
            }
        }
    } catch (err) {
        console.error('Failed to check group info:', err);
    }
}

function updateGroupVolumeUI() {
    const groupLabel = document.getElementById('group-label');
    const memberContainer = document.getElementById('member-volumes-container');

    if (groupLabel) {
        if (isGroupMode && groupSize > 1) {
            groupLabel.textContent = 'Gruppe (' + groupSize + ')';
            groupLabel.style.display = 'inline';
        } else {
            groupLabel.style.display = 'none';
        }
    }

    // Show/hide individual member volumes section
    if (memberContainer) {
        if (isGroupMode && groupSize > 1) {
            memberContainer.style.display = 'block';
        } else {
            memberContainer.style.display = 'none';
        }
    }
}

async function fetchGroupVolume() {
    try {
        const response = await fetch('/volume/group');
        if (response.ok) {
            const data = await response.json();
            if (data.is_group && data.volume !== undefined) {
                const slider = document.getElementById('volume-slider');
                const valueDisplay = document.getElementById('volume-value');
                if (slider && !volumeAdjusting) {
                    slider.value = data.volume;
                    valueDisplay.textContent = data.volume + '%';
                }
            }
        }
    } catch (err) {
        console.error('Failed to fetch group volume:', err);
    }
}

// Individual member volume functions
let memberVolumesExpanded = false;
let memberVolumeDebounceTimers = {};

function toggleMemberVolumes() {
    const list = document.getElementById('member-volumes-list');
    const arrow = document.getElementById('member-arrow');
    const toggleText = document.getElementById('member-toggle-text');

    memberVolumesExpanded = !memberVolumesExpanded;

    if (memberVolumesExpanded) {
        list.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
        toggleText.textContent = 'Lautsprecher ausblenden';
        fetchMemberVolumes();
    } else {
        list.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
        toggleText.textContent = 'Einzelne Lautsprecher';
    }
}

async function fetchMemberVolumes() {
    try {
        // Get selected device UUID from header button or localStorage
        const sonosBtn = document.getElementById('sonos-picker-toggle');
        let sonosUuid = sonosBtn ? sonosBtn.dataset.sonosUuid : null;
        if (!sonosUuid) {
            sonosUuid = localStorage.getItem('selectedSonosUUID');
        }

        // Build URL with optional uuid parameter
        let url = '/volume/members';
        if (sonosUuid) {
            url += '?uuid=' + encodeURIComponent(sonosUuid);
        }

        const response = await fetch(url);
        if (response.ok) {
            const data = await response.json();
            renderMemberVolumes(data.members || []);
        }
    } catch (err) {
        console.error('Failed to fetch member volumes:', err);
    }
}

function renderMemberVolumes(members) {
    const list = document.getElementById('member-volumes-list');
    if (!list) return;

    list.innerHTML = '';

    members.forEach(member => {
        const item = document.createElement('div');
        item.className = 'member-volume-item';
        item.dataset.ip = member.ip;

        const nameSpan = document.createElement('span');
        nameSpan.className = 'member-name';
        nameSpan.textContent = member.name;
        if (member.is_coordinator) {
            nameSpan.innerHTML += ' <span class="coordinator-badge">Koord.</span>';
        }

        const slider = document.createElement('input');
        slider.type = 'range';
        slider.className = 'member-volume-slider';
        slider.min = '0';
        slider.max = '100';
        slider.value = member.volume;
        slider.oninput = () => onMemberVolumeChange(member.ip, slider.value);
        slider.onchange = () => setMemberVolume(member.ip, slider.value);

        const valueSpan = document.createElement('span');
        valueSpan.className = 'member-volume-value';
        valueSpan.id = 'member-volume-' + member.ip.replace(/\./g, '-');
        valueSpan.textContent = member.volume + '%';

        item.appendChild(nameSpan);
        item.appendChild(slider);
        item.appendChild(valueSpan);
        list.appendChild(item);
    });
}

function onMemberVolumeChange(ip, value) {
    // Update display immediately
    const valueSpan = document.getElementById('member-volume-' + ip.replace(/\./g, '-'));
    if (valueSpan) {
        valueSpan.textContent = value + '%';
    }
}

function setMemberVolume(ip, value) {
    // Debounce per member
    clearTimeout(memberVolumeDebounceTimers[ip]);
    memberVolumeDebounceTimers[ip] = setTimeout(() => {
        const params = new URLSearchParams();
        params.append('ip', ip);
        params.append('volume', value);
        fetch('/volume/member', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params.toString()
        }).catch(err => {
            console.error('Failed to set member volume:', err);
        });
    }, 250);
}

function onVolumeChange(value) {
    // User is adjusting - set flag to prevent status updates from overwriting
    volumeAdjusting = true;
    clearTimeout(volumeAdjustTimeout);
    // Update display immediately
    document.getElementById('volume-value').textContent = value + '%';
}

function setVolume(value) {
    // Use different endpoint for group vs individual
    const endpoint = isGroupMode ? '/volume/group' : '/transport/volume';
    const debounceTime = isGroupMode ? 250 : 100;

    // Debounce to avoid spamming the server
    clearTimeout(volumeDebounceTimer);
    volumeDebounceTimer = setTimeout(() => {
        const params = new URLSearchParams();
        params.append('volume', value);
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params.toString()
        }).then(() => {
            // Reset flag after a delay to allow Sonos to update
            clearTimeout(volumeAdjustTimeout);
            volumeAdjustTimeout = setTimeout(() => {
                volumeAdjusting = false;
            }, 1500);

            // If group mode and member volumes are expanded, update them
            // (Sonos adjusts all member volumes proportionally when group volume changes)
            if (isGroupMode && memberVolumesExpanded) {
                // Wait a bit for Sonos to propagate the changes
                setTimeout(fetchMemberVolumes, 300);
            }
        }).catch(err => {
            console.error('Failed to set volume:', err);
            volumeAdjusting = false;
        });
    }, debounceTime);
}

function adjustVolume(delta) {
    const slider = document.getElementById('volume-slider');
    let newValue = parseInt(slider.value) + delta;
    // Clamp to 0-100
    newValue = Math.max(0, Math.min(100, newValue));
    slider.value = newValue;
    onVolumeChange(newValue);
    setVolume(newValue);
}

async function toggleMute() {
    try {
        const response = await fetch('/transport/mute', {
            method: 'POST'
        });
        if (response.ok) {
            const data = await response.json();
            updateMuteUI(data.muted);
        }
    } catch (err) {
        console.error('Failed to toggle mute:', err);
    }
}

function updateMuteUI(muted) {
    const volumeIcon = document.getElementById('volume-icon');
    const muteIcon = document.getElementById('mute-icon');
    if (muted) {
        volumeIcon.style.display = 'none';
        muteIcon.style.display = 'block';
    } else {
        volumeIcon.style.display = 'block';
        muteIcon.style.display = 'none';
    }
}

function updateVolumeUI(volume, muted) {
    // Skip volume update if user is currently adjusting
    if (volumeAdjusting) {
        // Only update mute state
        if (muted !== undefined) {
            updateMuteUI(muted);
        }
        return;
    }

    const slider = document.getElementById('volume-slider');
    const valueDisplay = document.getElementById('volume-value');
    if (slider && volume !== undefined) {
        slider.value = volume;
        valueDisplay.textContent = volume + '%';
    }
    if (muted !== undefined) {
        updateMuteUI(muted);
    }
}

// Group Editor functions
let groupEditorOpen = false;
let currentGroupCoordinatorUUID = '';

function openGroupEditor() {
    const modal = document.getElementById('group-modal');
    if (modal) {
        modal.style.display = 'flex';
        groupEditorOpen = true;
        fetchAllPlayers();
    }
}

function closeGroupEditor() {
    const modal = document.getElementById('group-modal');
    if (modal) {
        modal.style.display = 'none';
        groupEditorOpen = false;
    }
}

function closeGroupEditorOnOverlay(event) {
    if (event.target.id === 'group-modal') {
        closeGroupEditor();
    }
}

async function fetchAllPlayers() {
    const currentList = document.getElementById('group-current-list');
    const availableList = document.getElementById('group-available-list');

    try {
        // Get selected device UUID from header button or localStorage
        const sonosBtn = document.getElementById('sonos-picker-toggle');
        let sonosUuid = sonosBtn ? sonosBtn.dataset.sonosUuid : null;
        if (!sonosUuid) {
            sonosUuid = localStorage.getItem('selectedSonosUUID');
        }

        // Build URL with optional uuid parameter
        let url = '/sonos/all-players';
        if (sonosUuid) {
            url += '?uuid=' + encodeURIComponent(sonosUuid);
        }

        const response = await fetch(url);
        if (response.ok) {
            const data = await response.json();
            renderGroupLists(data);
        } else {
            currentList.innerHTML = '<div class="group-error">Fehler beim Laden</div>';
            availableList.innerHTML = '<div class="group-error">Fehler beim Laden</div>';
        }
    } catch (err) {
        console.error('Failed to fetch all players:', err);
        currentList.innerHTML = '<div class="group-error">Fehler beim Laden</div>';
        availableList.innerHTML = '<div class="group-error">Fehler beim Laden</div>';
    }
}

function renderGroupLists(data) {
    const currentList = document.getElementById('group-current-list');
    const availableList = document.getElementById('group-available-list');

    // Get the coordinator UUID from the current group
    const currentGroup = data.players.filter(p => p.in_current_group);
    const coordinator = currentGroup.find(p => p.is_coordinator);
    currentGroupCoordinatorUUID = coordinator ? coordinator.uuid : '';

    // Split players into current group and available
    const inGroup = data.players.filter(p => p.in_current_group);
    const available = data.players.filter(p => !p.in_current_group);

    // Render current group
    if (inGroup.length === 0) {
        currentList.innerHTML = '<div class="group-empty">Keine Lautsprecher in Gruppe</div>';
    } else {
        currentList.innerHTML = '';
        inGroup.forEach(player => {
            currentList.appendChild(createPlayerItem(player, true));
        });
    }

    // Render available players
    if (available.length === 0) {
        availableList.innerHTML = '<div class="group-empty">Keine weiteren Lautsprecher verfügbar</div>';
    } else {
        availableList.innerHTML = '';
        available.forEach(player => {
            availableList.appendChild(createPlayerItem(player, false));
        });
    }
}

function createPlayerItem(player, inGroup) {
    const item = document.createElement('div');
    item.className = 'group-player-item';
    item.dataset.uuid = player.uuid;
    item.dataset.ip = player.ip;

    const nameSpan = document.createElement('span');
    nameSpan.className = 'group-player-name';
    nameSpan.textContent = player.name;
    // Only show "Koord." badge for coordinators of multi-member groups
    if (player.is_coordinator && player.group_size > 1) {
        nameSpan.innerHTML += ' <span class="coordinator-badge">Koord.</span>';
    }

    const button = document.createElement('button');
    button.type = 'button';

    if (inGroup) {
        if (player.is_coordinator) {
            // Coordinator can't leave - it would break the group
            button.className = 'group-player-btn disabled';
            button.disabled = true;
            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            button.title = 'Koordinator kann nicht entfernt werden';
        } else {
            button.className = 'group-player-btn remove';
            button.onclick = () => removeFromGroup(player.ip);
            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
            button.title = 'Aus Gruppe entfernen';
        }
    } else {
        button.className = 'group-player-btn add';
        button.onclick = () => addToGroup(player.ip);
        button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
        button.title = 'Zur Gruppe hinzufügen';
    }

    item.appendChild(nameSpan);
    item.appendChild(button);
    return item;
}

async function addToGroup(playerIP) {
    if (!currentGroupCoordinatorUUID) {
        console.error('No coordinator UUID');
        return;
    }

    try {
        const params = new URLSearchParams();
        params.append('player_ip', playerIP);
        params.append('coordinator_uuid', currentGroupCoordinatorUUID);

        const response = await fetch('/sonos/group/join', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });

        if (response.ok) {
            // Wait for Sonos to propagate the group change (increased delay)
            setTimeout(() => {
                refreshAfterGroupChange();
            }, 800);
        } else {
            console.error('Failed to join group');
        }
    } catch (err) {
        console.error('Failed to add to group:', err);
    }
}

// Centralized refresh after any group change (add/remove)
async function refreshAfterGroupChange() {
    // Refresh the modal lists
    await fetchAllPlayers();
    // Update group info in main UI
    await checkGroupInfo();
    // Always refresh member volumes if visible (group mode)
    if (isGroupMode && groupSize > 1) {
        await fetchMemberVolumes();
    }
    // Refresh header device list (HTMX)
    refreshHeaderDeviceList();
}

async function removeFromGroup(playerIP) {
    try {
        const params = new URLSearchParams();
        params.append('player_ip', playerIP);

        const response = await fetch('/sonos/group/leave', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });

        if (response.ok) {
            // Wait for Sonos to propagate the group change
            setTimeout(() => {
                refreshAfterGroupChange();
            }, 800);
        } else {
            console.error('Failed to leave group');
        }
    } catch (err) {
        console.error('Failed to remove from group:', err);
    }
}

// Refresh the header device list to update group badges
function refreshHeaderDeviceList() {
    const deviceList = document.getElementById('sonos-device-list');
    if (deviceList && typeof htmx !== 'undefined') {
        // POST to /sonos/quick-refresh to update group sizes from Sonos quickly (no SSDP discovery)
        htmx.ajax('POST', '/sonos/quick-refresh', {target: '#sonos-device-list', swap: 'innerHTML'});
    }
}
</script>

<style>
.transport-controls {
    width: 100%;
    max-width: 400px;
}

/* Current Chapter Display */
.current-chapter {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    margin-bottom: 1rem;
    text-align: center;
}

.chapter-number-display {
    color: var(--text-muted);
    font-size: 0.75rem;
    font-weight: 500;
}

.chapter-title {
    color: var(--text);
    font-weight: 600;
    font-size: 0.9rem;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Progress Container */
.progress-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.time {
    font-size: 0.75rem;
    color: var(--text-muted);
    min-width: 50px;
}

.time:first-of-type {
    text-align: right;
}

/* Progress Slider Wrapper */
.progress-wrapper {
    flex: 1;
    position: relative;
    height: 20px;
    display: flex;
    align-items: center;
}

.progress-slider {
    width: 100%;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: var(--bg-card);
    border-radius: 3px;
    outline: none;
    cursor: pointer;
}

.progress-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--primary);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    transition: transform 0.1s;
}

.progress-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
}

.progress-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--primary);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* Chapter Markers */
.chapter-markers {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 6px;
    transform: translateY(-50%);
    pointer-events: none;
}

.chapter-marker {
    position: absolute;
    width: 2px;
    height: 12px;
    background: var(--text-muted);
    transform: translateX(-50%) translateY(-3px);
    cursor: pointer;
    pointer-events: auto;
    opacity: 0.6;
    transition: opacity 0.2s, height 0.2s;
}

.chapter-marker:hover {
    opacity: 1;
    height: 16px;
}

/* Chapter List */
.chapter-list-container {
    margin-bottom: 1.5rem;
}

.chapter-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem;
    background: none;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-muted);
    font-size: 0.875rem;
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
}

.chapter-toggle:hover {
    color: var(--text);
    border-color: var(--text-muted);
}

.chapter-toggle svg {
    transition: transform 0.2s;
}

.chapter-list {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 0.5rem;
    border: 1px solid var(--border);
    border-radius: 4px;
}

.chapter-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.5rem 0.75rem;
    background: none;
    border: none;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    text-align: left;
    cursor: pointer;
    transition: background-color 0.2s;
}

.chapter-item:last-child {
    border-bottom: none;
}

.chapter-item:hover {
    background: var(--bg-card);
}

.chapter-item.active {
    background: #1db95420; /* --primary with 12.5% opacity */
    border-left: 3px solid var(--primary);
    padding-left: calc(0.75rem - 3px);
}

.chapter-item.active .chapter-number {
    background: var(--primary);
    color: white;
}

.chapter-item.active .chapter-name {
    color: var(--primary);
    font-weight: 600;
}

.chapter-number {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-card);
    border-radius: 50%;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.chapter-name {
    flex: 1;
    font-size: 0.875rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.transport-buttons {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.transport-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--text);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 50%;
    transition: background-color 0.2s, transform 0.1s;
}

.transport-btn:hover {
    background: var(--bg-card);
}

.transport-btn:active {
    transform: scale(0.95);
}

.chapter-skip-btn {
    color: var(--primary);
}

.chapter-skip-btn:hover {
    background: rgba(var(--primary-rgb), 0.1);
}

.play-btn, .pause-btn {
    width: 64px;
    height: 64px;
    background: var(--primary);
    color: white;
}

.play-btn:hover, .pause-btn:hover {
    background: var(--primary-dark);
}

.transport-secondary {
    display: flex;
    justify-content: center;
}

.transport-btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: background-color 0.2s, color 0.2s;
}

.transport-btn-secondary:hover {
    background: var(--bg-card);
    color: var(--text);
}

.volume-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding: 0 1rem;
}

.volume-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: color 0.2s;
}

.volume-btn:hover {
    color: var(--text);
}

.volume-adjust-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.35rem;
    border-radius: 4px;
    transition: background-color 0.2s, color 0.2s, border-color 0.2s;
    flex-shrink: 0;
}

.volume-adjust-btn:hover {
    background: var(--bg-hover);
    color: var(--text);
    border-color: var(--text-muted);
}

.volume-adjust-btn:active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.volume-slider {
    flex: 1;
    max-width: 150px;
    height: 4px;
    -webkit-appearance: none;
    appearance: none;
    background: var(--bg-card);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
}

.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--primary);
    cursor: pointer;
    transition: transform 0.1s;
}

.volume-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
}

.volume-slider::-moz-range-thumb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--primary);
    cursor: pointer;
    border: none;
}

.volume-value {
    font-size: 0.75rem;
    color: var(--text-muted);
    min-width: 35px;
    text-align: right;
}

.group-label {
    font-size: 0.7rem;
    color: var(--primary);
    background: rgba(29, 185, 84, 0.15);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    white-space: nowrap;
    font-weight: 500;
}

/* Individual Member Volumes */
.member-volumes-container {
    margin-bottom: 1rem;
    padding: 0 1rem;
}

.member-volumes-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    width: 100%;
    padding: 0.4rem;
    background: none;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-muted);
    font-size: 0.8rem;
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
}

.member-volumes-toggle:hover {
    color: var(--text);
    border-color: var(--text-muted);
}

.member-volumes-toggle svg {
    transition: transform 0.2s;
}

.member-volumes-list {
    margin-top: 0.5rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.5rem;
}

.member-volume-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0;
    border-bottom: 1px solid var(--border);
}

.member-volume-item:last-child {
    border-bottom: none;
}

.member-name {
    flex: 0 0 auto;
    min-width: 80px;
    font-size: 0.8rem;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.coordinator-badge {
    font-size: 0.65rem;
    color: var(--primary);
    background: rgba(29, 185, 84, 0.15);
    padding: 0.1rem 0.25rem;
    border-radius: 3px;
    margin-left: 0.25rem;
}

.member-volume-slider {
    flex: 1;
    height: 4px;
    -webkit-appearance: none;
    appearance: none;
    background: var(--bg-card);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
}

.member-volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary);
    cursor: pointer;
}

.member-volume-slider::-moz-range-thumb {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary);
    cursor: pointer;
    border: none;
}

.member-volume-value {
    flex: 0 0 auto;
    min-width: 35px;
    font-size: 0.7rem;
    color: var(--text-muted);
    text-align: right;
}

/* Group Button */
.group-btn {
    margin-left: 0.5rem;
}

/* Group Editor Modal */
.group-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
}

.group-modal {
    background: var(--bg);
    border-radius: 8px;
    width: 100%;
    max-width: 360px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.group-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

.group-modal-header h3 {
    margin: 0;
    font-size: 1rem;
    color: var(--text);
}

.group-modal-close {
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: color 0.2s, background-color 0.2s;
}

.group-modal-close:hover {
    color: var(--text);
    background: var(--bg-card);
}

.group-modal-body {
    padding: 1rem;
    overflow-y: auto;
    max-height: calc(80vh - 60px);
}

.group-section {
    margin-bottom: 1.25rem;
}

.group-section:last-child {
    margin-bottom: 0;
}

.group-section h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.8rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.group-current-list,
.group-available-list {
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
}

.group-loading,
.group-error,
.group-empty {
    padding: 1rem;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.85rem;
}

.group-error {
    color: #e57373;
}

.group-player-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid var(--border);
}

.group-player-item:last-child {
    border-bottom: none;
}

.group-player-name {
    flex: 1;
    font-size: 0.9rem;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.group-player-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: background-color 0.2s, opacity 0.2s;
}

.group-player-btn.add {
    background: rgba(29, 185, 84, 0.15);
    color: var(--primary);
}

.group-player-btn.add:hover {
    background: rgba(29, 185, 84, 0.3);
}

.group-player-btn.remove {
    background: rgba(229, 115, 115, 0.15);
    color: #e57373;
}

.group-player-btn.remove:hover {
    background: rgba(229, 115, 115, 0.3);
}

.group-player-btn.disabled {
    background: var(--bg-card);
    color: var(--text-muted);
    cursor: not-allowed;
    opacity: 0.5;
}
</style>
{{end}}
