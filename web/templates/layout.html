<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Audiobookshelf Sonos Bridge">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ABS Sonos">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="512x512" href="/static/audiobookshelf-bridge-WebApp-Icon.png">
    <title>{{if .Title}}{{.Title}} - {{end}}Audiobookshelf Sonos Bridge</title>
    <link rel="stylesheet" href="/static/style.css?v=5">
    <script src="/static/htmx.min.js" defer></script>
</head>
<body>
    {{if .ShowHeader}}
    <header class="header">
        <div class="header-content">
            <a href="/libraries" class="logo">
                <img src="/static/Audiobookshelf-bridge-logo-dark.png" alt="Audiobookshelf Sonos Bridge" class="logo-img logo-dark">
                <img src="/static/Audiobookshelf-bridge-logo-light.png" alt="Audiobookshelf Sonos Bridge" class="logo-img logo-light">
            </a>
            {{if .Username}}
            <div class="header-actions">
                <button type="button" id="sonos-picker-toggle" class="btn btn-icon" title="Select Sonos Device">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect>
                        <circle cx="12" cy="14" r="4"></circle>
                        <line x1="12" y1="6" x2="12.01" y2="6"></line>
                    </svg>
                    <span id="selected-device-name" class="device-badge"></span>
                </button>
                <div class="user-menu">
                    <span class="username">{{.Username}}</span>
                    <form action="/auth/logout" method="POST" class="logout-form">
                        <button type="submit" class="btn btn-link">Logout</button>
                    </form>
                </div>
            </div>
            {{end}}
        </div>
    </header>
    <!-- Sonos Device Picker Modal -->
    <div id="sonos-picker-modal" class="modal" style="display: none;">
        <div class="modal-backdrop" id="modal-backdrop"></div>
        <div class="modal-content">
            {{template "sonos-picker" .}}
        </div>
    </div>
    <script>
    function toggleSonosPicker(e) {
        if (e) e.preventDefault();
        const modal = document.getElementById('sonos-picker-modal');
        modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
    }
    // Update device badge on selection
    document.addEventListener('sonosDeviceSelected', function(e) {
        const btn = document.getElementById('sonos-picker-toggle');
        btn.dataset.sonosUuid = e.detail.uuid;
        document.getElementById('selected-device-name').textContent = e.detail.name;
        toggleSonosPicker();
    });
    // Setup event listeners on load (better iOS WebApp support than onclick)
    document.addEventListener('DOMContentLoaded', function() {
        // Sonos picker toggle button
        const toggleBtn = document.getElementById('sonos-picker-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', toggleSonosPicker);
            toggleBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                toggleSonosPicker();
            });
        }
        // Modal backdrop close
        const backdrop = document.getElementById('modal-backdrop');
        if (backdrop) {
            backdrop.addEventListener('click', toggleSonosPicker);
            backdrop.addEventListener('touchend', function(e) {
                e.preventDefault();
                toggleSonosPicker();
            });
        }
        // Restore saved device name and UUID
        const savedName = localStorage.getItem('selectedSonosName');
        const savedUUID = localStorage.getItem('selectedSonosUUID');
        if (savedName) {
            document.getElementById('selected-device-name').textContent = savedName;
        }
        if (savedUUID && toggleBtn) {
            toggleBtn.dataset.sonosUuid = savedUUID;
        }

        // Start group polling
        startGroupPolling();
    });

    // Group polling mechanism - checks for Sonos group changes every 10 seconds
    let lastGroupState = null;
    let groupPollInterval = null;
    let lastUserInteraction = 0;  // Timestamp of last user interaction
    const INTERACTION_PAUSE_MS = 10000;  // Pause polling for 10 seconds after interaction

    // Called by transport controls to pause polling during user interaction
    function markUserInteraction() {
        lastUserInteraction = Date.now();
    }

    function startGroupPolling() {
        // Don't start if already running
        if (groupPollInterval) return;

        // Poll every 10 seconds
        groupPollInterval = setInterval(pollGroups, 10000);

        // Also poll immediately on start to get initial state
        pollGroups();
    }

    function stopGroupPolling() {
        if (groupPollInterval) {
            clearInterval(groupPollInterval);
            groupPollInterval = null;
        }
    }

    async function pollGroups() {
        // Skip polling if user recently interacted (prevents race conditions)
        if (Date.now() - lastUserInteraction < INTERACTION_PAUSE_MS) {
            console.debug('Polling paused due to recent user interaction');
            return;
        }

        try {
            const response = await fetch('/sonos/poll-groups');
            if (!response.ok) return;

            const data = await response.json();
            const newState = JSON.stringify(data.devices);

            // Check if state changed
            if (lastGroupState !== null && lastGroupState !== newState) {
                console.log('Group state changed, refreshing UI');
                onGroupStateChanged();
            }

            lastGroupState = newState;
        } catch (err) {
            // Silently ignore polling errors (network issues, etc.)
            console.debug('Group polling failed:', err);
        }
    }

    function onGroupStateChanged() {
        // Refresh the device list in the picker modal
        const deviceList = document.getElementById('sonos-device-list');
        if (deviceList && typeof htmx !== 'undefined') {
            htmx.ajax('GET', '/sonos/devices', {target: '#sonos-device-list', swap: 'innerHTML'});
        }

        // Dispatch event for other components (e.g., transport controls)
        document.dispatchEvent(new CustomEvent('sonosGroupsChanged'));
    }

    // Stop polling when page is hidden (saves resources)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopGroupPolling();
        } else {
            startGroupPolling();
        }
    });
    </script>
    {{end}}

    <main class="main-content">
        {{block "content" .}}{{end}}
    </main>

    {{if .ShowFooter}}
    <footer class="footer">
        <p>Audiobookshelf Sonos Bridge</p>
    </footer>
    {{end}}
</body>
</html>
